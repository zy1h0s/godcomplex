<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Bluetooth Device Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: transparent;
    }

    #titlebar {
      width: 100%;
      height: 28px;
      background: rgba(0, 0, 0, 0.95);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      -webkit-app-region: drag;
    }

    .title {
      color: rgba(255, 255, 255, 0.9);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    #controls {
      display: flex;
      gap: 4px;
      -webkit-app-region: no-drag;
    }

    .control-btn {
      width: 20px;
      height: 20px;
      border: none;
      cursor: pointer;
      font-size: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.8);
      transition: all 0.2s;
      font-weight: bold;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    #container {
      width: 100%;
      height: calc(100% - 28px);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    body.minimized #container {
      display: none;
    }

    body.minimized #titlebar {
      height: 100%;
      border-bottom: none;
    }

    #imageContent {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: none;
    }

    #placeholder {
      color: rgba(255, 255, 255, 0.5);
      font-family: Arial, sans-serif;
      font-size: 16px;
      text-align: center;
      padding: 20px;
    }

    .click-through-indicator {
      position: absolute;
      bottom: 5px;
      right: 5px;
      padding: 4px 8px;
      background: rgba(102, 126, 234, 0.8);
      color: white;
      border-radius: 4px;
      font-size: 11px;
      display: none;
      -webkit-app-region: no-drag;
    }
  </style>
</head>
<body>
  <div id="titlebar">
    <span class="title">IMAGE</span>
    <div id="controls">
      <button class="control-btn" onclick="openSettings()" title="Settings">⚙</button>
      <button class="control-btn" onclick="toggleMinimize()" title="Minimize/Restore" id="minimizeBtn">−</button>
      <button class="control-btn" onclick="closeWindow()" title="Close">×</button>
    </div>
  </div>
  <div id="container">
    <div id="placeholder">Waiting for image...</div>
    <img id="imageContent" alt="Overlay Image">
    <div class="click-through-indicator" id="clickThroughIndicator">Click-through: ON</div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const io = require('socket.io-client');

    let socket = null;
    let session = null;
    let settings = null;

    const WS_URL = process.env.WS_URL || 'https://godcomplex.onrender.com';

    // Initialize
    ipcRenderer.on('init-overlay', (event, data) => {
      session = data.session;
      settings = data.settings;

      applySettings(settings);
      connectSocket();
    });

    // Apply visual settings
    function applySettings(settings) {
      const container = document.getElementById('container');
      container.style.background = hexToRgba('#000000', settings.bgOpacity || 0.3);
    }

    // Connect to WebSocket
    function connectSocket() {
      socket = io(WS_URL);

      socket.on('connect', () => {
        console.log('Connected to server');
        socket.emit('join-session', {
          sessionId: session.id,
          userId: 'viewer',
          username: 'Viewer'
        });
      });

      socket.on('session-data', ({ imageUrl }) => {
        updateImage(imageUrl);
      });

      socket.on('image-update', ({ imageUrl }) => {
        updateImage(imageUrl);
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from server');
      });
    }

    // Update image display
    function updateImage(imageUrl) {
      const imageElement = document.getElementById('imageContent');
      const placeholder = document.getElementById('placeholder');

      if (imageUrl) {
        imageElement.src = imageUrl;
        imageElement.style.display = 'block';
        placeholder.style.display = 'none';
      } else {
        imageElement.style.display = 'none';
        placeholder.style.display = 'block';
      }
    }

    // Settings update
    ipcRenderer.on('settings-updated', (event, newSettings) => {
      settings = { ...settings, ...newSettings };
      applySettings(settings);
    });

    // Click-through indicator
    ipcRenderer.on('click-through-changed', (event, isClickThrough) => {
      const indicator = document.getElementById('clickThroughIndicator');
      if (isClickThrough) {
        indicator.style.display = 'block';
        setTimeout(() => {
          indicator.style.display = 'none';
        }, 2000);
      }
    });

    // Helper function
    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function openSettings() {
      ipcRenderer.send('open-settings');
    }

    function toggleMinimize() {
      ipcRenderer.send('toggle-minimize', 'image');
    }

    function closeWindow() {
      window.close();
    }

    // Handle minimize state
    ipcRenderer.on('minimized-state', (event, isMinimized) => {
      if (isMinimized) {
        document.body.classList.add('minimized');
        document.getElementById('minimizeBtn').textContent = '□';
      } else {
        document.body.classList.remove('minimized');
        document.getElementById('minimizeBtn').textContent = '−';
      }
    });
  </script>
</body>
</html>
