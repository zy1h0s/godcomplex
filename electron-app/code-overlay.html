<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' http://localhost:3001 https://godcomplex.onrender.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src http://localhost:3001 ws://localhost:3001 https://godcomplex.onrender.com wss://godcomplex.onrender.com">
  <title>Bluetooth Device Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      background: transparent;
    }

    #titlebar {
      width: 100%;
      height: 28px;
      background: rgba(0, 0, 0, 0.95);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      -webkit-app-region: drag;
    }

    .title {
      color: rgba(255, 255, 255, 0.9);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    #controls {
      display: flex;
      gap: 4px;
      -webkit-app-region: no-drag;
    }

    .control-btn {
      width: 20px;
      height: 20px;
      border: none;
      cursor: pointer;
      font-size: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.8);
      transition: all 0.2s;
      font-weight: bold;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    #container {
      width: 100%;
      height: calc(100% - 28px);
      padding: 20px;
    }

    body.minimized #container {
      display: none;
    }

    body.minimized #titlebar {
      height: 100%;
      border-bottom: none;
    }

    #code-display {
      width: 100%;
      height: 100%;
      background: rgba(30, 30, 30, 0.95);
      border: 2px solid rgba(255, 255, 255, 0.1);
      padding: 20px;
      overflow: auto;
      -webkit-app-region: no-drag;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }

    #code {
      color: #00ff00;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      display: block;
    }

    #debug-status {
      position: absolute;
      top: 40px;
      right: 10px;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      font-size: 11px;
      border-radius: 4px;
      z-index: 1000;
      font-family: Arial, sans-serif;
    }

    #debug-status.connected {
      background: rgba(0, 255, 0, 0.8);
      color: black;
    }

    /* Scrollbar styling */
    #code-display::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    #code-display::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }

    #code-display::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }

    #code-display::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .empty {
      color: rgba(255, 255, 255, 0.3);
      font-style: italic;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="titlebar">
    <span class="title">CODE</span>
    <div id="controls">
      <button class="control-btn" onclick="openSettings()" title="Settings">⚙</button>
      <button class="control-btn" onclick="toggleMinimize()" title="Minimize/Restore" id="minimizeBtn">−</button>
      <button class="control-btn" onclick="closeWindow()" title="Close">×</button>
    </div>
  </div>

  <div id="debug-status">Initializing...</div>

  <div id="container">
    <div id="code-display">
      <code id="code">Waiting for code...</code>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    console.log('=== CODE OVERLAY SCRIPT STARTING ===');
    const { ipcRenderer } = require('electron');

    // Use local socket.io-client module instead of CDN
    let io;
    try {
      io = require('socket.io-client');
      console.log('✅ Socket.IO loaded from node_modules');
    } catch (error) {
      console.error('❌❌❌ Socket.IO NOT LOADED! ❌❌❌');
      console.error('Error:', error);
      document.getElementById('debug-status').textContent = 'ERROR: Socket.IO not found!';
      document.getElementById('debug-status').style.background = 'rgba(255, 0, 0, 0.9)';
      document.getElementById('code').innerHTML = '<span style="color: red;">ERROR: Socket.IO module not found.<br><br>Error: ' + error.message + '</span>';
    }

    // Use config.js for URL, fallback to production URL
    const WS_URL = (window.APP_CONFIG && window.APP_CONFIG.WS_URL) || 'https://godcomplex.onrender.com';
    console.log('WebSocket URL:', WS_URL);
    console.log('Config loaded?', !!window.APP_CONFIG);
    let socket = null;
    let session = null;
    let settings = null;

    const codeElement = document.getElementById('code');
    const codeDisplay = document.getElementById('code-display');
    const debugStatus = document.getElementById('debug-status');

    function setStatus(message, isGood = false) {
      console.log('STATUS:', message);
      debugStatus.textContent = message;
      if (isGood) {
        debugStatus.classList.add('connected');
      } else {
        debugStatus.classList.remove('connected');
      }
    }

    // Initialize overlay
    ipcRenderer.on('init-overlay', (event, data) => {
      console.log('=== INIT-OVERLAY EVENT ===');
      console.log('Full data:', JSON.stringify(data, null, 2));

      session = data.session;
      settings = data.settings;

      if (!session) {
        console.error('❌ NO SESSION DATA!');
        setStatus('ERROR: No session!');
        codeElement.innerHTML = '<span style="color: red;">ERROR: No session data provided!</span>';
        return;
      }

      console.log('✅ Session ID:', session.id);
      console.log('✅ Session data:', session);
      setStatus('Session loaded: ' + session.id.substring(0, 8) + '...');

      // Apply settings
      if (settings) {
        const opacity = settings.bgOpacity || 0.95;
        codeDisplay.style.background = `rgba(30, 30, 30, ${opacity})`;
        console.log('✅ Settings applied, opacity:', opacity);
      }

      // Connect to WebSocket
      connectSocket();
    });

    function connectSocket() {
      console.log('=== CONNECTING TO WEBSOCKET ===');
      console.log('URL:', WS_URL);

      // Check if Socket.IO is available
      if (typeof io === 'undefined') {
        console.error('❌ Cannot connect: Socket.IO not available!');
        setStatus('ERROR: Socket.IO not loaded!');
        codeElement.innerHTML = '<span style="color: red;">ERROR: Socket.IO library not loaded. Cannot connect to server.</span>';
        return;
      }

      setStatus('Connecting to ' + WS_URL + '...');

      try {
        socket = io(WS_URL, {
          transports: ['websocket', 'polling'],
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionAttempts: 10
        });
      } catch (error) {
        console.error('❌ Error creating Socket.IO connection:', error);
        setStatus('ERROR: ' + error.message);
        codeElement.innerHTML = '<span style="color: red;">ERROR creating connection: ' + error.message + '</span>';
        return;
      }

      socket.on('connect', () => {
        console.log('✅✅✅ CONNECTED TO WEBSOCKET! ✅✅✅');
        setStatus('Connected to server!', true);

        if (session) {
          console.log('Emitting join-session:', {
            sessionId: session.id,
            userId: session.userId || 'viewer',
            username: 'Viewer'
          });

          socket.emit('join-session', {
            sessionId: session.id,
            userId: session.userId || 'viewer',
            username: 'Viewer'
          });

          setStatus('Joined session: ' + session.id.substring(0, 8) + '...', true);
        } else {
          console.error('❌ NO SESSION WHEN TRYING TO JOIN!');
          setStatus('ERROR: No session to join!');
        }
      });

      socket.on('session-data', (data) => {
        console.log('=== SESSION-DATA EVENT ===');
        console.log('Data keys:', Object.keys(data));
        console.log('Has code?', !!data.code);
        console.log('Code length:', data.code ? data.code.length : 0);
        if (data.code) {
          console.log('Code preview:', data.code.substring(0, 100));
        }
        setStatus('Received session data', true);
        updateCode(data.code || '');
      });

      socket.on('code-update', (data) => {
        console.log('=== CODE-UPDATE EVENT ===');
        console.log('Data:', data);
        console.log('Code length:', data.code ? data.code.length : 0);
        if (data.code) {
          console.log('Code preview:', data.code.substring(0, 100));
        }
        setStatus('Code updated!', true);
        updateCode(data.code);
      });

      socket.on('connect_error', (error) => {
        console.error('❌❌❌ CONNECTION ERROR ❌❌❌');
        console.error('Error:', error);
        console.error('Error message:', error.message);
        setStatus('Connection error: ' + error.message);
        codeElement.innerHTML = '<span style="color: red;">WebSocket connection error: ' + error.message + '</span>';
      });

      socket.on('disconnect', (reason) => {
        console.log('⚠️⚠️⚠️ DISCONNECTED ⚠️⚠️⚠️');
        console.log('Reason:', reason);
        setStatus('Disconnected: ' + reason);
      });

      socket.on('error', (error) => {
        console.error('❌ Socket error:', error);
        setStatus('Socket error!');
      });
    }

    function updateCode(code) {
      console.log('=== UPDATE CODE CALLED ===');
      console.log('Code received?', !!code);
      console.log('Code length:', code ? code.length : 0);
      console.log('Code type:', typeof code);

      if (code && code.trim()) {
        console.log('✅ DISPLAYING CODE');
        console.log('First 200 chars:', code.substring(0, 200));

        // Just show it as plain text - NO PRISM, NO FANCY STUFF
        codeElement.textContent = code;
        codeElement.style.color = '#00ff00'; // Bright green so you KNOW it's working
        codeElement.style.display = 'block';

        setStatus('Displaying ' + code.length + ' chars', true);
      } else {
        console.log('⚠️ NO CODE TO DISPLAY');
        codeElement.innerHTML = '<span class="empty">No code received yet. Send code from frontend.</span>';
      }
    }

    function openSettings() {
      ipcRenderer.send('open-settings');
    }

    function toggleMinimize() {
      ipcRenderer.send('toggle-minimize', 'code');
    }

    function closeWindow() {
      window.close();
    }

    // Handle minimize state
    ipcRenderer.on('minimized-state', (event, isMinimized) => {
      if (isMinimized) {
        document.body.classList.add('minimized');
        document.getElementById('minimizeBtn').textContent = '□';
      } else {
        document.body.classList.remove('minimized');
        document.getElementById('minimizeBtn').textContent = '−';
      }
    });

    // Handle click-through toggle
    ipcRenderer.on('click-through-changed', (event, enabled) => {
      console.log('Click-through changed:', enabled);
    });

    console.log('=== CODE OVERLAY SCRIPT LOADED ===');
    setStatus('Script loaded, waiting for init...');
  </script>
</body>
</html>
